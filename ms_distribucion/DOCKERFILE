FROM python:3.12-slim AS runtime

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    # Ajusta si tu m√≥dulo wsgi se llama distinto:
    DJANGO_SETTINGS_MODULE=ms_distribucion.settings \
    # Ruta por defecto a los contratos (puedes override en runtime)
    CONTRACTS_DIR=/contracts/schemas

WORKDIR /app

# Paquetes del sistema para psycopg2, Pillow, etc.
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential gcc \
    libpq-dev \
    libjpeg62-turbo-dev zlib1g-dev \
  && rm -rf /var/lib/apt/lists/*

COPY requirements*.txt ./ 
RUN pip install -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["gunicorn", "ms_distribucion.wsgi:application", "-b", "0.0.0.0:8000", "-w", "3", "--timeout", "120"]

FROM runtime AS test
# Paquetes de desarrollo (pytest/coverage/etc.)
RUN if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
# Comando por defecto de este target
CMD ["pytest"]